# ---- BUILD STAGE: compile Vite (React+TS) ----
FROM node:24.5-alpine AS build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

ENV NODE_ENV=production
RUN npm run build

# ---- RUNTIME STAGE: nginx serving static assets ----
FROM nginx:stable-alpine

# Install yq and jq for config parsing
RUN apk add --no-cache wget tar \
    && wget https://github.com/mikefarah/yq/releases/download/v4.44.2/yq_linux_amd64.tar.gz -O yq.tar.gz \
    && tar xzf yq.tar.gz \
    && mv yq_linux_amd64 /usr/bin/yq \
    && rm yq.tar.gz \
    && chmod +x /usr/bin/yq \
    && wget https://github.com/jqlang/jq/releases/download/jq-1.7/jq-linux-amd64 -O /usr/bin/jq \
    && chmod +x /usr/bin/jq

# Copy relevant files
COPY nginx.conf /etc/nginx/nginx.conf
COPY --from-build /app/dist /usr/share/nginx/html
COPY --from-build /app/configs /app/configs
COPY --from-build /app/entrypoint.sh /app/entrypoint.sh

RUN chmod +x /app/entrypoint.sh

EXPOSE 8080

WORKDIR /app

## Ensure /tmp is writable for NGINX temp files and logs
# This VOLUME declaration is required for AWS Fargate and other read-only root environments.
# Without it, NGINX cannot create temp files or logs, and the frontend will fail to start.
# Applies to any container runtime with a read-only root filesystem.
VOLUME ["/tmp"]

ENTRYPOINT ["./entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
